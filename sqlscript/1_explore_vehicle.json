{
	"name": "1_explore_vehicle",
	"properties": {
		"folder": {
			"name": "electric_vehicle/explorer"
		},
		"content": {
			"query": "--Consultas a un archivo \"vehicle.csv\" en un contenedor \"electric-vehicle-data\" del Datalake\n\n-- con Dirección URL\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK 'https://entixcoviddl.dfs.core.windows.net/electric-vehicle-data/bronze/vehicle.csv',\n        FORMAT = 'CSV',\n        PARSER_VERSION = '2.0'\n    ) AS [result];\n\n-- con Ruta de ABFSS (Azure Blob File System)\nSELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK 'abfss://electric-vehicle-data@entixcoviddl.dfs.core.windows.net/bronze/vehicle.csv',\n        FORMAT = 'CSV',\n        PARSER_VERSION = '2.0',\n        HEADER_ROW = TRUE,\n        FIELDTERMINATOR = ',',\n        ROWTERMINATOR = '\\n'\n    ) AS [result];\n\n\n--tipos de datos y largos asignados por Synapse\nEXEC sp_describe_first_result_set N'SELECT\n    TOP 100 *\nFROM\n    OPENROWSET(\n        BULK ''abfss://electric-vehicle-data@entixcoviddl.dfs.core.windows.net/bronze/vehicle.csv'',\n        FORMAT = ''CSV'',\n        PARSER_VERSION = ''2.0'',\n        HEADER_ROW = TRUE\n    ) AS [result];'\n\n-- muestra el max_length del registro mas largo de cada columna \nSELECT\n    MAX(LEN(vehicleId)) AS vehicleId,\n    MAX(LEN(vin)) AS vin,\n    MAX(LEN(modelYear)) AS modelYear,\n    MAX(LEN(make)) AS make,\n    MAX(LEN(model)) AS model,\n    MAX(LEN(electricRange)) AS electricRange,\n    MAX(LEN(baseMSRP)) AS baseMSRP,\n    MAX(LEN(vehicheTypeId)) AS vehicheTypeId,\n    MAX(LEN(cafvEligibilityId)) AS cafvEligibilityId,\n    MAX(LEN(vehicleLocation)) AS vehicleLocation\nFROM\n    OPENROWSET(\n        BULK 'abfss://electric-vehicle-data@entixcoviddl.dfs.core.windows.net/bronze/vehicle.csv',\n        FORMAT = 'CSV',\n        PARSER_VERSION = '2.0',\n        HEADER_ROW = TRUE\n    ) AS [result];\n\n--asigna un tamaño de dato maximo a las columnas consultando los datos mediante un procedimiento almacedado para ese efecto\nSELECT TOP 100 *\nFROM OPENROWSET(\n    BULK 'https://entixcoviddl.dfs.core.windows.net/electric-vehicle-data/bronze/vehicle.csv',\n    FORMAT = 'CSV',\n    PARSER_VERSION = '2.0',\n    HEADER_ROW = TRUE\n) WITH (\n    vehicleId         INT,\n    vin               VARCHAR(10),\n    modelYear         SMALLINT,\n    make              VARCHAR(25),\n    model             VARCHAR(25),\n    electricRange     SMALLINT,\n    baseMSRP          INT,\n    vehicheTypeId     SMALLINT,\n    cafvEligibilityId SMALLINT,\n    vehicleLocation   VARCHAR(30)\n) AS [result];  \n\n\nEXEC sp_describe_first_result_set N'\nSELECT TOP 100 *\nFROM OPENROWSET(\n    BULK ''https://entixcoviddl.dfs.core.windows.net/electric-vehicle-data/bronze/vehicle.csv'',\n    FORMAT = ''CSV'',\n    PARSER_VERSION = ''2.0'',\n    HEADER_ROW = TRUE\n) WITH (\n    vehicleId         INT,\n    vin               VARCHAR(10),\n    modelYear         SMALLINT,\n    make              VARCHAR(25),\n    model             VARCHAR(25),\n    electricRange     SMALLINT,\n    baseMSRP          INT,\n    vehicheTypeId     SMALLINT,\n    cafvEligibilityId SMALLINT,\n    vehicleLocation   VARCHAR(30)\n) AS [result];'\n\n\n-- verifica la codificacion de las tablas de sistemas\n    --SELECT name, collation_name FROM sys.databases;\n\n\n-- specify UTF-8 Collation for VARCHAR columns\n    --CREATE DATABASE electric_vehicle_explorer;\nUSE electric_vehicle_explorer;\n\n    --ALTER DATABASE electric_vehicle_explorer COLLATE Latin1_General_100_CI_AI_SC_UTF8;\n\n--cambia, para efectos de consulta, el tipo y largo de datos. Tambien asigna en numero de columna a la que hace referencia en el archivo\nSELECT TOP 100 *\nFROM OPENROWSET(\n    BULK 'https://entixcoviddl.dfs.core.windows.net/electric-vehicle-data/bronze/vehicle.csv',\n    FORMAT = 'CSV',\n    PARSER_VERSION = '2.0',\n    HEADER_ROW = TRUE\n) WITH (\n    vehicleId         INT 1,\n    vin               VARCHAR(10) 2,\n    modelYear         SMALLINT 3,\n    make              VARCHAR(25) 4,\n    model             VARCHAR(25) 5,\n    electricRange     SMALLINT 6,\n    baseMSRP          INT 7,\n    vehicheTypeId     SMALLINT 8,\n    cafvEligibilityId SMALLINT 9,\n    vehicleLocation   VARCHAR(30) 10\n) AS [result];\n\n\n-- select only a subset of columns from a csv file without columns names\nSELECT TOP 100 *\nFROM OPENROWSET(\n    BULK 'https://entixcoviddl.dfs.core.windows.net/electric-vehicle-data/bronze/vehicle_without_header.csv',\n    FORMAT = 'CSV',\n    PARSER_VERSION = '2.0'\n) WITH (\n    vin               VARCHAR(10) 2, --asigna un nombre de columna y su posicion dentro de las columnas existentes en el archivo\n    make              VARCHAR(25) 4,\n    model             VARCHAR(25) 5\n) AS [result];\n\n\n\n--Create a External Datasource\nCREATE EXTERNAL DATA SOURCE electric_vehicle_data\nWITH( \n    LOCATION = 'abfss://electric-vehicle-data@entixcoviddl.dfs.core.windows.net/'\n);\n    --DROP EXTERNAL DATA SOURCE electric_vehicle_data;\n\nCREATE EXTERNAL DATA SOURCE electric_vehicle_data_bronze\nWITH( \n    LOCATION = 'abfss://electric-vehicle-data@entixcoviddl.dfs.core.windows.net/bronze/'\n);\n\nSELECT TOP 100 *\nFROM OPENROWSET(\n    BULK 'vehicle.csv',\n    DATA_SOURCE = 'electric_vehicle_data_bronze',\n    FORMAT = 'CSV',\n    PARSER_VERSION = '2.0',\n    HEADER_ROW = TRUE\n) WITH (\n    vin               VARCHAR(10), \n    make              VARCHAR(25) ,\n    model             VARCHAR(25) \n) AS [result];\n\n    --SELECT name, location FROM sys.external_data_sources;\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "electric_vehicle_explorer",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}